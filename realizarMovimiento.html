}<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestión de Preventas - Tienda de Ropa</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <style>
      body {
        background-color: #f8f9fa;
      }
      h1 {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container my-4">
      <h1 class="text-center">Gestión de Preventas - Tienda de Ropa</h1>
      <table class="table table-bordered mt-4">
        <thead class="thead-dark">
          <tr>
            <th>Cliente</th>
            <th>Total</th>
            <th>Abono</th>
            <th>Monto Pendiente</th>
            <th>Código</th>
            <th>Método de Pago</th>
            <th>Estado</th>
            <th>Fecha Preventa</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="preventasTableBody">
          <!-- Se llenará dinámicamente -->
        </tbody>
      </table>
    </div>

    <!-- Bootstrap JS Bundle y dependencias -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Importar Firebase y Firestore a través de firebase-config.js -->
    <script type="module">
      // Importa la instancia de Firestore desde firebase-config.js
      import { db } from "./firebase-config.js";
      import {
        collection,
        query,
        where,
        orderBy,
        onSnapshot
      } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
      
      // Referencia a la colección "ventas"
      const ventasRef = collection(db, "ventas");
      // Consulta para obtener solo las ventas de tipo "preventa", ordenadas por fecha descendente
      const preventasQuery = query(
        ventasRef,
        where("tipoVenta", "==", "preventa"),
        orderBy("fecha", "desc")
      );
      
      // Función para renderizar las preventas en la tabla
      function renderPreventas() {
        const tbody = document.getElementById("preventasTableBody");
        tbody.innerHTML = "";
        onSnapshot(preventasQuery, (snapshot) => {
          snapshot.forEach((doc) => {
            const preventa = doc.data();
            // Calcular el monto pendiente: total - montoAbono
            const montoAbono = preventa.montoAbono || 0;
            const pendiente = preventa.total - montoAbono;
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${preventa.cliente.nombre || preventa.cliente}</td>
              <td>Q ${preventa.total.toFixed(2)}</td>
              <td>Q ${montoAbono.toFixed(2)}</td>
              <td>Q ${pendiente.toFixed(2)}</td>
              <td>${preventa.codigo || "-"}</td>
              <td>${preventa.metodo_pago || "-"}</td>
              <td>${preventa.estado || "-"}</td>
              <td>${new Date(preventa.fecha).toLocaleDateString()}</td>
              <td>
                <button class="btn btn-sm btn-info" onclick="verDetallesPreventa('${doc.id}')">
                  <i class="fa fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-secondary" onclick="descargarComprobantePreventa('${doc.id}')">
                  <i class="fa fa-download"></i>
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
      }
      
      // Funciones de ejemplo para ver detalles y descargar comprobante
      window.verDetallesPreventa = function(id) {
        Swal.fire("Detalles", "Aquí se mostrarían los detalles de la preventa: " + id, "info");
      };
      
      window.descargarComprobantePreventa = function(id) {
        Swal.fire("Descargar", "Función para descargar comprobante de preventa: " + id, "info");
      };
      
      renderPreventas();
    </script>
  </body>
</html>
